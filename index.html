<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Investment Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS for font and general styling -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f4f7f9;
        }
        #root {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
    </style>
    <!-- Load React, ReactDOM, and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Lucide Icons -->
    <!-- We load the icons here and let them process the DOM once, preventing conflicts -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <div id="root">
        <!-- React App will be rendered here -->
    </div>

    <!-- 
        Firebase Initialization and Authentication (Standard Module) 
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.authReady = false; // Global flag for React to watch
        window.userId = null;

        let auth, db; 

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase Auth error:", error);
                    window.authReady = true; // Still flag as ready even on error
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.userId = user.uid; 
                    window.authReady = true; // Authentication successful
                } else {
                    authenticate(); // Trigger sign-in if not signed in
                }
            });
        } else {
            console.error("Firebase Configuration is missing. Running without persistent storage.");
            window.isFirebaseSkipped = true;
            window.authReady = true;
        }
    </script>


    <!-- 
        Main Application Logic (React Component)
    -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Mock data for simulated exchange portfolios
        const MOCK_PORTFOLIOS = {
            'Binance': [
                { asset: 'BTC', amount: 0.5, valueUSD: 35000 },
                { asset: 'ETH', amount: 5.2, valueUSD: 16000 },
                { asset: 'BNB', amount: 15, valueUSD: 7000 },
            ],
            'CoinSpot': [
                { asset: 'ADA', amount: 1200, valueUSD: 800 },
                { asset: 'DOT', amount: 450, valueUSD: 3200 },
                { asset: 'XRP', amount: 5000, valueUSD: 2500 },
            ]
        };
        
        // --- Shared Components ---

        const MessageModal = ({ message, type, onClose }) => {
            if (!message) return null;

            const baseStyle = "p-4 rounded-lg shadow-2xl text-white";
            const color = type === 'error' ? 'bg-red-600' : 'bg-blue-600';

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                    <div className={`max-w-sm w-full ${baseStyle} ${color} relative`}>
                        <p className="text-lg font-semibold mb-2">{type === 'error' ? 'Error' : 'Notification'}</p>
                        <p>{message}</p>
                        <button
                            onClick={onClose}
                            className="mt-4 w-full bg-white bg-opacity-20 hover:bg-opacity-30 transition font-bold py-2 px-4 rounded"
                        >
                            Close
                        </button>
                    </div>
                </div>
            );
        };
        
        // Stabilized Icon component: relies purely on the global Lucide script loaded in the <head>
        const Icon = ({ name, className }) => {
            return <i data-lucide={name} className={className} />;
        };

        // --- Exchange Connection Modal (The "Popup") ---

        const ConnectExchangeModal = ({ isVisible, onClose, onConnect, showMessage }) => {
            const [selectedExchange, setSelectedExchange] = useState('Binance');
            const [apiKey, setApiKey] = useState('');
            const [apiSecret, setApiSecret] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            if (!isVisible) return null;

            const handleConnect = () => {
                if (!apiKey || !apiSecret) {
                    showMessage('Please enter both API Key and API Secret.', 'error');
                    return;
                }
                
                setIsLoading(true);

                // Simulate secure API call delay
                setTimeout(() => {
                    onConnect(selectedExchange, { apiKey, apiSecret, portfolio: MOCK_PORTFOLIOS[selectedExchange] });
                    showMessage(`Successfully connected and fetched simulated data from ${selectedExchange}.`, 'info');
                    
                    setIsLoading(false);
                    onClose();
                    
                    setApiKey('');
                    setApiSecret('');
                }, 1500);
            };

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 space-y-4 transform transition-all scale-100">
                        <h3 className="text-2xl font-bold text-gray-800 flex items-center">
                            <Icon name="plug-zap" className="w-6 h-6 mr-3 text-yellow-600" />
                            Connect Cryptocurrency Exchange
                        </h3>
                        <p className="text-gray-600 text-sm">
                            **IMPORTANT:** Due to security and environment constraints, this connection is **simulated**. Do not enter real API keys.
                        </p>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Select Platform</label>
                            <select
                                value={selectedExchange}
                                onChange={(e) => setSelectedExchange(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                            >
                                <option>Binance</option>
                                <option>CoinSpot</option>
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">API Key (Mock)</label>
                            <input
                                type="password"
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                placeholder="Enter Simulated API Key"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">API Secret (Mock)</label>
                            <input
                                type="password"
                                value={apiSecret}
                                onChange={(e) => setApiSecret(e.target.value)}
                                placeholder="Enter Simulated API Secret"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                            />
                        </div>

                        <div className="flex justify-end space-x-3 pt-2">
                            <button
                                onClick={onClose}
                                disabled={isLoading}
                                className="px-6 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition disabled:opacity-50"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleConnect}
                                disabled={isLoading}
                                className="px-6 py-2 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition shadow-md disabled:opacity-50 flex items-center"
                            >
                                {isLoading ? (
                                    <>
                                        <Icon name="loader-circle" className="w-4 h-4 mr-2 animate-spin" />
                                        Connecting...
                                    </>
                                ) : (
                                    'Connect & Fetch Data'
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Portfolio Display Component ---

        const PortfolioDisplay = ({ linkedExchanges }) => {
            const allAssets = linkedExchanges.flatMap(e => e.data.portfolio);
            if (allAssets.length === 0) {
                return (
                    <div className="text-center p-8 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <Icon name="cloud-off" className="w-8 h-8 mx-auto text-gray-400 mb-2" />
                        <p className="text-gray-500">No exchange accounts linked yet.</p>
                        <p className="text-sm text-gray-400">Use the "Connect Exchange" button to start fetching simulated data.</p>
                    </div>
                );
            }

            const totalValue = allAssets.reduce((sum, asset) => sum + asset.valueUSD, 0);

            return (
                <div className="p-6 bg-green-50 rounded-xl border border-green-200 shadow-inner">
                    <h2 className="flex items-center text-2xl font-bold text-gray-700 mb-4">
                        <Icon name="wallet" className="w-6 h-6 mr-3 text-green-600" />
                        Consolidated Portfolio Overview
                    </h2>
                    <div className="bg-white p-4 rounded-lg shadow-md mb-4 flex justify-between items-center border-l-4 border-green-500">
                        <span className="text-lg font-semibold text-gray-700">Total Portfolio Value:</span>
                        <span className="text-3xl font-extrabold text-green-600">${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                    </div>

                    {linkedExchanges.map(exchange => (
                        <div key={exchange.name} className="mt-4 p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                             <h3 className="font-semibold text-lg text-gray-800 mb-2 flex justify-between items-center">
                                {exchange.name} Assets
                            </h3>
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Asset</th>
                                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                        <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Value (USD)</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {exchange.data.portfolio.map((item, index) => (
                                        <tr key={index} className="hover:bg-yellow-50">
                                            <td className="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{item.asset}</td>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-500">{item.amount.toFixed(4)}</td>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-right text-gray-900">${item.valueUSD.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ))}
                </div>
            );
        }

        // --- Main App Component ---

        const App = () => {
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('info');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState('...'); 
            const [isModalVisible, setIsModalVisible] = useState(false);
            const [linkedExchanges, setLinkedExchanges] = useState([]); 

            // Function to show custom message
            const showMessage = (msg, type = 'info') => {
                setMessage(msg);
                setMessageType(type);
                setTimeout(() => setMessage(''), 5000); 
            };
            
            // Function to handle connection from modal
            const handleConnectExchange = (name, data) => {
                setLinkedExchanges(prev => {
                    const existingIndex = prev.findIndex(e => e.name === name);
                    if (existingIndex > -1) {
                        const newState = [...prev];
                        newState[existingIndex] = { name, data };
                        return newState;
                    }
                    return [...prev, { name, data }];
                });
            };

            // Authentication/Loading Check Effect (Simplified to only watch global flags)
            useEffect(() => {
                let interval;
                
                if (window.isFirebaseSkipped) {
                    setIsAuthReady(true);
                    setUserId('Local Sandbox User (No Firebase)');
                    return;
                }

                // Check global flag set by the module script every 100ms
                interval = setInterval(() => {
                    if (window.authReady) {
                        clearInterval(interval);
                        setIsAuthReady(true);
                        setUserId(window.userId || 'Auth Failed/Timeout');
                        if (window.userId) {
                            showMessage("Dashboard loaded successfully.", 'info');
                        } else {
                            // Only show this warning if running in the Canvas
                            if (window.location.host.includes('canvas')) {
                                console.warn("Firebase authentication did not complete successfully. Using fallback ID.");
                            }
                        }
                    }
                }, 100);

                return () => clearInterval(interval);
                
            }, []); 

            if (!isAuthReady) {
                return (
                    <div className="flex flex-col items-center justify-center p-8 bg-white shadow-xl rounded-xl max-w-lg w-full">
                        <Icon name="loader-circle" className="w-8 h-8 animate-spin text-blue-500 mb-4" />
                        <p className="text-gray-600">Initializing dashboard and authenticating...</p>
                        <p className="text-sm text-gray-400 mt-2">The live site should load immediately, as Firebase auth is skipped there.</p>
                    </div>
                );
            }

            // --- Main Dashboard Render ---
            return (
                <div className="container max-w-4xl mx-auto p-4 md:p-8 bg-white shadow-2xl rounded-2xl">
                    <MessageModal 
                        message={message} 
                        type={messageType} 
                        onClose={() => setMessage('')} 
                    />
                    <ConnectExchangeModal
                        isVisible={isModalVisible}
                        onClose={() => setIsModalVisible(false)}
                        onConnect={handleConnectExchange}
                        showMessage={showMessage}
                    />
                    
                    <header className="text-center mb-10">
                        <h1 className="text-4xl font-extrabold text-gray-800 tracking-tight mb-2">
                            AI Crypto Dashboard
                        </h1>
                        <p className="text-md text-blue-500 font-medium">
                            Simulated Exchange Connectivity & Gemini Analysis
                        </p>
                        <div className="mt-4 p-2 bg-gray-50 rounded-lg text-sm text-gray-500 break-words">
                            <span className="font-semibold text-gray-700">User ID (for persistence):</span> {userId}
                        </div>
                    </header>
                    
                    <div className="space-y-8">
                        
                        {/* 1. Connect Exchange Button Section */}
                        <section className="p-6 bg-yellow-50 rounded-xl border border-yellow-200 shadow-inner text-center">
                             <button
                                onClick={() => setIsModalVisible(true)}
                                className="px-8 py-3 bg-yellow-600 text-white font-bold text-lg rounded-xl hover:bg-yellow-700 transition shadow-lg transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center mx-auto"
                            >
                                <Icon name="link" className="w-6 h-6 mr-3" />
                                Connect Exchange Accounts
                            </button>
                            <p className="mt-3 text-sm text-gray-600">
                                Currently linked: {linkedExchanges.map(e => e.name).join(', ') || 'None'}
                            </p>
                        </section>

                        {/* 2. Portfolio Display Section */}
                        <PortfolioDisplay linkedExchanges={linkedExchanges} />

                        {/* 3. Analysis Input Section */}
                        <section className="p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-inner">
                            <h2 className="flex items-center text-2xl font-bold text-gray-700 mb-4">
                                <Icon name="cpu" className="w-6 h-6 mr-3 text-blue-600" />
                                AI Investment Analysis
                            </h2>
                            <p className="text-gray-600 mb-4">
                                Ask Gemini to analyze market trends or specific assets.
                            </p>
                            
                            <textarea
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shadow-sm resize-none"
                                rows="3"
                                placeholder="E.g., Analyze the recent performance of Bitcoin and Ethereum."
                            ></textarea>
                            
                            <button
                                className="mt-4 w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition shadow-lg transform hover:scale-[1.01] active:scale-[0.99]"
                                onClick={() => showMessage("Gemini Analysis feature is ready to be implemented.", 'info')}
                            >
                                Run Analysis
                                <Icon name="trending-up" className="w-4 h-4 ml-2 inline-block" />
                            </button>
                        </section>
                        
                    </div>
                    
                    <footer className="mt-10 pt-6 border-t border-gray-200 text-center text-sm text-gray-400">
                        &copy; 2025 AI Dashboard. This application is a mock-up due to client-side security constraints.
                    </footer>
                </div>
            );
        };

        // Render the App component once
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
