<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Investment Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS for font and general styling -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f4f7f9;
        }
        #root {
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to the top of the viewport */
            min-height: 100vh;
            padding: 2rem 1rem;
        }
    </style>
    <!-- Load React, ReactDOM, and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <div id="root">
        <!-- React App will be rendered here -->
    </div>

    <!-- 
        Firebase Initialization and Authentication (Standard Module) 
        This part remains a standard JS module type="module" for ES imports.
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firestore log level for debugging
        setLogLevel('debug');

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Expose configuration and service getters to the global scope
        window.getFirebaseConfig = () => firebaseConfig;
        window.getAppId = () => appId;
        window.getAuth = () => auth;
        window.getDb = () => db;

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // 1. Attempt to sign in with the custom token
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase Auth error:", error);
                }
            }

            // 2. Set up auth state change listener and run the app
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in. We can now run the main React component.
                    console.log("User authenticated. UID:", user.uid);
                    // Set global state that React can monitor
                    window.userId = user.uid; 
                    // Trigger rendering in the React/Babel script block
                    if (window.renderApp) {
                        window.renderApp();
                    }
                } else {
                    // User is signed out (this happens after the initial sign-in attempt if the token is invalid or not available)
                    console.log("User signed out. Attempting sign-in...");
                    authenticate();
                }
            });
        } else {
            console.error("Firebase Configuration is missing. Running without persistent storage.");
            // If Firebase is missing, we still need to run the app
            if (window.renderApp) {
                window.renderApp();
            }
        }
    </script>


    <!-- 
        Main Application Logic (React Component)
        *** THIS SCRIPT MUST HAVE type="text/babel" for JSX to be processed by Babel. ***
    -->
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Simple component to display a message box instead of alert()
        const MessageModal = ({ message, type, onClose }) => {
            if (!message) return null;

            const baseStyle = "p-4 rounded-lg shadow-2xl text-white";
            const color = type === 'error' ? 'bg-red-600' : 'bg-blue-600';

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                    <div className={`max-w-sm w-full ${baseStyle} ${color} relative`}>
                        <p className="text-lg font-semibold mb-2">{type === 'error' ? 'Error' : 'Notification'}</p>
                        <p>{message}</p>
                        <button
                            onClick={onClose}
                            className="mt-4 w-full bg-white bg-opacity-20 hover:bg-opacity-30 transition font-bold py-2 px-4 rounded"
                        >
                            Close
                        </button>
                    </div>
                </div>
            );
        };
        
        // Icon wrapper for Lucide icons
        const Icon = ({ name, className }) => {
            useEffect(() => {
                // Ensure lucide is defined before attempting to replace icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} />;
        };

        // Main App Component
        const App = () => {
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('info');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(window.userId || '...'); // Placeholder for user ID

            // Function to show custom message
            const showMessage = (msg, type = 'info') => {
                setMessage(msg);
                setMessageType(type);
                setTimeout(() => setMessage(''), 5000); // Auto-hide after 5 seconds
            };
            
            // Initialization and Auth Check Effect
            useEffect(() => {
                // Check if the user ID has been set by the module script
                const checkAuth = () => {
                    if (window.userId) {
                        setUserId(window.userId);
                        setIsAuthReady(true);
                        showMessage("User ID linked to Firestore access.", 'info');
                    } else {
                         // Fallback for immediate check if the module script hasn't finished yet
                         const authInterval = setInterval(() => {
                            if (window.userId) {
                                setUserId(window.userId);
                                setIsAuthReady(true);
                                clearInterval(authInterval);
                            }
                         }, 100);
                         // Don't wait forever, just let the app run without Firestore if needed
                         setTimeout(() => {
                            if (!window.userId) {
                                setIsAuthReady(true);
                            }
                         }, 1000); 
                    }
                };

                checkAuth();

                // Expose the app logic entry point to the module script
                window.renderApp = checkAuth;

            }, []); // Run once on mount

            if (!isAuthReady) {
                return (
                    <div className="flex flex-col items-center justify-center p-8 bg-white shadow-xl rounded-xl max-w-lg w-full">
                        <Icon name="loader-circle" className="w-8 h-8 animate-spin text-blue-500 mb-4" />
                        <p className="text-gray-600">Initializing dashboard and authenticating...</p>
                    </div>
                );
            }

            return (
                <div className="container max-w-4xl mx-auto p-4 md:p-8 bg-white shadow-2xl rounded-2xl">
                    <MessageModal 
                        message={message} 
                        type={messageType} 
                        onClose={() => setMessage('')} 
                    />
                    
                    <header className="text-center mb-10">
                        <h1 className="text-4xl font-extrabold text-gray-800 tracking-tight mb-2">
                            AI Investment Dashboard
                        </h1>
                        <p className="text-md text-blue-500 font-medium">
                            Powered by Gemini Analysis and Firestore Persistence
                        </p>
                        <div className="mt-4 p-2 bg-gray-50 rounded-lg text-sm text-gray-500 break-words">
                            <span className="font-semibold text-gray-700">User ID (for persistence):</span> {userId}
                        </div>
                    </header>
                    
                    <div className="space-y-8">
                        
                        {/* 1. Analysis Input Section */}
                        <section className="p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-inner">
                            <h2 className="flex items-center text-2xl font-bold text-gray-700 mb-4">
                                <Icon name="trending-up" className="w-6 h-6 mr-3 text-blue-600" />
                                Get Real-Time Investment Analysis
                            </h2>
                            <p className="text-gray-600 mb-4">
                                Ask Gemini to analyze a stock, market trend, or financial report. For current data, analysis will be grounded in Google Search results.
                            </p>
                            
                            <textarea
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shadow-sm resize-none"
                                rows="3"
                                placeholder="E.g., Summarize the latest quarterly earnings report for Google and provide a buy/sell/hold recommendation."
                            ></textarea>
                            
                            <button
                                className="mt-4 w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition shadow-lg transform hover:scale-[1.01] active:scale-[0.99]"
                                onClick={() => showMessage("Analysis Feature not yet implemented.", 'info')}
                            >
                                Run Analysis
                                <Icon name="cpu" className="w-4 h-4 ml-2 inline-block" />
                            </button>
                        </section>

                        {/* 2. Portfolio/Saved Data Section (Mock) */}
                        <section className="p-6 bg-green-50 rounded-xl border border-green-200 shadow-inner">
                            <h2 className="flex items-center text-2xl font-bold text-gray-700 mb-4">
                                <Icon name="wallet" className="w-6 h-6 mr-3 text-green-600" />
                                Saved Portfolio Data
                            </h2>
                            <p className="text-gray-600 mb-4">
                                This section will use Firestore to save your personalized watchlists and analysis notes.
                            </p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="p-4 bg-white rounded-lg border border-gray-200 shadow-md">
                                    <h3 className="font-semibold text-lg text-gray-800">Watchlist</h3>
                                    <ul className="list-disc list-inside text-gray-600 mt-2">
                                        <li>GOOGL (Last Analysis: Buy)</li>
                                        <li>TSLA (Last Analysis: Hold)</li>
                                    </ul>
                                </div>
                                <div className="p-4 bg-white rounded-lg border border-gray-200 shadow-md">
                                    <h3 className="font-semibold text-lg text-gray-800">Key Metrics</h3>
                                    <p className="text-gray-600">Last Synced: 5 min ago</p>
                                    <p className="text-sm text-green-500 font-bold mt-2">
                                        Total Portfolio Change: +1.2%
                                    </p>
                                </div>
                            </div>

                        </section>
                        
                    </div>
                    
                    <footer className="mt-10 pt-6 border-t border-gray-200 text-center text-sm text-gray-400">
                        &copy; 2025 AI Dashboard. All rights reserved. Mock-up functionality.
                    </footer>
                </div>
            );
        };

        // Render the App component once authentication is ready (or immediately if Firebase is skipped)
        const root = ReactDOM.createRoot(document.getElementById('root'));

        // Function exposed to the module script to trigger rendering after auth
        window.renderApp = () => {
             // We check again in case this function is called immediately before window.userId is set
             if (!window.userId) {
                // If auth is still pending, we wait for the onAuthStateChanged listener to call renderApp again.
                // For now, render the App component with the loading state.
                root.render(<App />);
                return;
             }
             root.render(<App />);
        }

        // Initial render (will show loading state if window.userId is not yet available)
        // The module script's onAuthStateChanged listener will call window.renderApp when ready.
        root.render(<App />);

    </script>
</body>
</html>
